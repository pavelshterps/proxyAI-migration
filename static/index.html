<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- … ваши стили … -->
</head>
<body>
  <!-- … ваши кнопки и элементы … -->
  <button id="uploadBtn">Загрузить</button>
  <button id="requestDiarizeBtn" disabled>Запустить Диаризацию</button>
  <button id="saveLabelsBtn">Сохранить метки</button>
  <!-- … остальной UI … -->
  <div id="status"></div>
  <div id="timings"></div>
  <div id="transcriptContainer"></div>

<script>
;(function(){
  const apiKeyEl   = document.getElementById("apiKey"),
        fileEl     = document.getElementById("audioFile"),
        uploadBtn  = document.getElementById("uploadBtn"),
        statusEl   = document.getElementById("status"),
        timingsEl  = document.getElementById("timings"),
        diarizeBtn = document.getElementById("requestDiarizeBtn"),
        saveBtn    = document.getElementById("saveLabelsBtn"),
        audioEl    = document.getElementById("audio"),
        container  = document.getElementById("transcriptContainer");

  let uploadId, mapping = {}, savePending = false, startTs;

  function fmt(ms){
    const sec = Math.floor(ms/1000),
          m   = String(Math.floor(sec/60)).padStart(2,"0"),
          s   = String(sec%60).padStart(2,"0");
    return `${m}:${s}`;
  }

  uploadBtn.onclick = async () => {
    // reset UI
    diarizeBtn.disabled = true;
    saveBtn.disabled = false;      // всегда активна
    container.innerHTML = "";
    timingsEl.innerHTML  = "";
    mapping              = {};
    savePending          = false;

    const key  = apiKeyEl.value.trim(),
          file = fileEl.files[0];
    if (!key || !file) {
      alert("API-Key и файл обязательно");
      return;
    }

    audioEl.src   = URL.createObjectURL(file);
    statusEl.textContent = "Загружаем…";

    // start timer
    startTs = performance.now();

    let res;
    try {
      const form = new FormData();
      form.append("file", file);
      res = await fetch("/upload/", {
        method: "POST",
        headers: {"X-API-Key": key},
        body: form
      });
      if (!res.ok) throw new Error(res.statusText);
      const data = await res.json();
      uploadId = data.upload_id;
    } catch(e) {
      alert("Ошибка: " + e.message);
      statusEl.textContent = "Ошибка";
      return;
    }

    statusEl.textContent = "Ждём результатов…";

    const es = new EventSource(`/events/${uploadId}?api_key=${encodeURIComponent(key)}`);

    es.onmessage = e => {
      const msg = e.data.trim();
      if (!msg || msg === ":") return;
      const st = JSON.parse(msg.replace(/^data:\s*/,""));
      statusEl.textContent = `Статус: ${st.status}`;

      if (st.preview && !mapping.__initialized) {
        mapping.__initialized = true;
        render(st.preview.timestamps);
        timingsEl.innerHTML += `<div>Preview: ${((performance.now() - startTs)/1000).toFixed(2)}s</div>`;
      }

      if (st.status === "transcript_done") {
        timingsEl.innerHTML += `<div>Transcript: ${((performance.now() - startTs)/1000).toFixed(2)}s</div>`;
        loadResults();
      }

      if (st.status === "diarize_requested") {
        diarizeBtn.disabled = false;
      }

      if (st.status === "diarization_done") {
        timingsEl.innerHTML += `<div>Diarization: ${((performance.now() - startTs)/1000).toFixed(2)}s</div>`;
        saveBtn.disabled = false;
        loadResults();
        es.close();
      }
    };

    es.onerror = () => {
      statusEl.textContent = "Ошибка потока событий";
      diarizeBtn.disabled = true;
      saveBtn.disabled    = false;  // пусть остаётся активной
    };
  };

  async function loadResults(){
    statusEl.textContent = "Загружаю…";
    const key = apiKeyEl.value.trim();
    const res = await fetch(`/results/${uploadId}`, {
      headers: {"X-API-Key": key}
    });
    if (!res.ok) {
      statusEl.textContent = "Ошибка";
      return;
    }
    const {results} = await res.json();
    render(results);
    statusEl.textContent = "Готово";
  }

  diarizeBtn.onclick = async () => {
    diarizeBtn.disabled = true;
    statusEl.textContent = "Запрос диаризации…";
    const key = apiKeyEl.value.trim();
    await fetch(`/diarize/${uploadId}`, {
      method: "POST",
      headers: {"X-API-Key": key}
    });
  };

  saveBtn.onclick = async () => {
    if (!savePending) return;
    const key     = apiKeyEl.value.trim(),
          payload = {};
    Object.entries(mapping).forEach(([orig, s]) => {
      if (orig !== "__initialized") payload[orig] = s;
    });
    const res = await fetch(`/labels/${uploadId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Key": key
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      alert("Ошибка");
      return;
    }
    const {results} = await res.json();
    render(results);
    statusEl.textContent = "Метки сохранены";
    savePending = false;
  };

  function render(segments){
    container.innerHTML = "";
    mapping.__initialized = mapping.__initialized || false;
    segments.forEach(seg => {
      const orig = String(seg.orig ?? seg.speaker ?? "");
      if (!mapping.hasOwnProperty(orig)) mapping[orig] = seg.speaker || orig;

      const div = document.createElement("div");
      div.className = "segment";

      const ts = document.createElement("span");
      ts.className  = "time";
      ts.textContent = fmt(seg.start * 1000);
      div.append(ts);

      const pb = document.createElement("button");
      pb.textContent = "▶️";
      pb.onclick = () => {
        audioEl.currentTime = seg.start;
        audioEl.play();
        setTimeout(() => audioEl.pause(), (seg.end - seg.start)*1000);
      };
      div.append(pb);

      const inp = document.createElement("input");
      inp.value = mapping[orig];
      inp.dataset.orig = orig;
      inp.onchange = () => {
        const v = inp.value.trim();
        if (!v || v.length > 50) {
          alert("Имя 1–50 символов");
          inp.value = mapping[orig];
          return;
        }
        mapping[orig]    = v;
        savePending      = true;
        saveBtn.disabled = false;
        container.querySelectorAll("input").forEach(i => {
          if (i.dataset.orig === orig) i.value = v;
        });
      };
      div.append(inp);

      const txt = document.createElement("span");
      txt.textContent = seg.text;
      div.append(txt);

      container.append(div);
    });
  }

})();
</script>
</body>
</html>
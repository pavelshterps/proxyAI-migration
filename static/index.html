<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>proxyAI Demo UI</title>
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    .segment { border-bottom: 1px solid #ccc; padding: .5rem 0; }
    .time { color: #666; margin-right: .5rem; }
    .segment input { width: 180px; margin-left: .5rem; }
    .segment button { margin-left: .5rem; }
  </style>
</head>
<body>
  <h1>proxyAI Demo UI</h1>
  <label>Ваш API-Key:<input id="apiKey" /></label>
  <label>Файл:<input type="file" id="audioFile" accept="audio/*,video/*" /></label>
  <button id="uploadBtn">Загрузить и начать</button>
  <div id="status">Готово</div>
  <h2>Плеер</h2>
  <audio id="audio" controls style="width:100%"></audio>
  <h2>Результаты</h2>
  <div id="transcriptContainer"></div>
  <button id="saveLabelsBtn" disabled>Сохранить метки</button>

  <script>
  (async function(){
    const apiKeyEl = document.getElementById('apiKey');
    const fileEl   = document.getElementById('audioFile');
    const uploadBtn= document.getElementById('uploadBtn');
    const statusEl = document.getElementById('status');
    const audioEl  = document.getElementById('audio');
    const container= document.getElementById('transcriptContainer');
    const saveBtn  = document.getElementById('saveLabelsBtn');

    let uploadId, fileBlob;
    let previewDone=false, transcriptDone=false, diarizeDone=false;
    let mapping = {};

    function formatTime(ms){
      const s = Math.floor(ms/1000), m = Math.floor(s/60);
      return `${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    }

    uploadBtn.onclick = async () => {
      const key = apiKeyEl.value.trim();
      if(!key){ alert("Введите API-Key"); return; }
      const file = fileEl.files[0];
      if(!file){ alert("Выберите файл"); return; }

      fileBlob = file;
      statusEl.textContent = "Загружаем…";

      const fd = new FormData();
      fd.append("file", file);
      const res = await fetch("/upload/", {
        method:"POST",
        headers:{"X-API-Key":key},
        body: fd
      });
      if(!res.ok){ alert("Ошибка при загрузке"); return; }
      uploadId = (await res.json()).upload_id;

      // сброс
      previewDone = transcriptDone = diarizeDone = false;
      container.innerHTML = "";
      saveBtn.disabled = true;

      // старт SSE
      const evt = new EventSource(`/events/${uploadId}`);
      evt.onmessage = async e => {
        const st = JSON.parse(e.data);
        statusEl.textContent = `Статус: ${st.status}`;
        if(st.status==="preview_done" && !previewDone){
          previewDone=true; await loadResults(); }
        if(st.status==="transcript_done" && !transcriptDone){
          transcriptDone=true; await loadResults(); }
        if(st.status==="diarization_done" && !diarizeDone){
          diarizeDone=true; await loadResults(); evt.close(); saveBtn.disabled=false; }
      };

      statusEl.textContent = "Ожидаем…";
    };

    async function loadResults(){
      statusEl.textContent = "Загрузка результатов…";
      const key = apiKeyEl.value.trim();
      const res = await fetch(`/results/${uploadId}`, {
        headers:{"X-API-Key":key}
      });
      if(!res.ok) return;
      const {results} = await res.json();
      audioEl.src = URL.createObjectURL(fileBlob);
      container.innerHTML = "";
      mapping = {};
      results.forEach(s=>mapping[s.speaker||""]=s.speaker||"");
      results.forEach(seg=>{
        const div = document.createElement("div"); div.className="segment";
        const time = document.createElement("span"); time.className="time";
        time.textContent = formatTime(seg.start*1000);
        const play = document.createElement("button"); play.textContent="▶️";
        play.onclick = ()=>{
          audioEl.currentTime = seg.start;
          audioEl.play();
          setTimeout(()=>audioEl.pause(), (seg.end-seg.start)*1000+200);
        };
        const inp = document.createElement("input"); inp.value=seg.speaker||"";
        inp.onchange = ()=>{
          const old=seg.speaker||"", neu=inp.value.trim();
          if(neu && neu.length<=50){
            mapping[old]=neu;
            container.querySelectorAll('input')
                     .forEach(i=>{ if(i.value===old) i.value=neu; });
          } else { alert("1–50 символов"); inp.value=mapping[old]; }
        };
        const txt = document.createElement("span"); txt.textContent=seg.text;
        div.append(time,play,inp,txt);
        container.append(div);
      });
      statusEl.textContent = "Готово";
    }

    saveBtn.onclick = async ()=>{
      const key = apiKeyEl.value.trim();
      const payload = {};
      for(const [o,n] of Object.entries(mapping)) if(o!==n) payload[o]=n;
      if(!Object.keys(payload).length) return alert("Нет изменений");
      const res = await fetch(`/labels/${uploadId}`, {
        method:"POST",
        headers:{"Content-Type":"application/json","X-API-Key":key},
        body: JSON.stringify(payload)
      });
      if(!res.ok) return alert("Ошибка");
      alert("Метки сохранены");
    };

  })();
  </script>
</body>
</html>